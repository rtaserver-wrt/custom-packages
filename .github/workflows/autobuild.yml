# Copyright (C) 2025 rtaserver-wrt

name: ğŸ—ï¸ AutoCompiler OpenWrt Packages

on:
  # workflow_run:
  #   workflows: ["Auto Sync App"]
  #   types: [completed]

  push:
    branches: [main]
    paths-ignore:
      - '.github/workflows/**'
      - 'README.md'
    paths:
      - 'feeds/**'

  workflow_dispatch:
    inputs:
      compile_pkg:
        description: 'ğŸ“¦ Compile packages (default: all packages)'
        required: false
        default: ''
        type: string

      verbose:
        description: 'ğŸ” Verbose output level'
        required: false
        default: '0'
        type: choice
        options: ['0', '1', '2']

      without_pages:
        description: 'ğŸš« Skip GitHub Pages deployment'
        required: true
        default: false
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: auto-compiler-${{ github.ref }}
  cancel-in-progress: true

env:
  # ğŸ¯ Global environment variables
  DEBIAN_FRONTEND: noninteractive
  FORCE_UNSAFE_CONFIGURE: 1

jobs:
  # ğŸ”¨ Main compilation job with matrix strategy
  build_ipk:
    name: ğŸ—ï¸ Build [${{ matrix.release }}] [${{ matrix.arch }}]
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    env:
      SDK_CACHE_DIR: ${{ github.workspace }}/sdk_cache
    
    strategy:
      fail-fast: false
      matrix:
        release: [
          SNAPSHOT, 
          24.10.2, 
          23.05.5
        ]
        arch: [
          x86_64,
          mips_24kc,
          mipsel_24kc,
          arm_cortex-a7_neon-vfpv4,
          aarch64_cortex-a53,
          aarch64_cortex-a72,
          aarch64_generic
        ]

    steps:
      # ğŸ“¥ Repository setup
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      # âš¡ Smart caching for dependencies
      - name: âš¡ Cache APT Packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: ${{ runner.os }}-apt-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-apt-

      # ğŸ”§ Install build dependencies
      - name: ğŸ”§ Install Build Dependencies
        run: |
          echo "::group::ğŸ”§ Installing build dependencies"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools rsync swig unzip zlib1g-dev file wget
          
          # ğŸ Python dependencies
          sudo pip3 install --upgrade pip
          sudo pip3 install meson ninja
          echo "::endgroup::"

      # ğŸ“ Prepare SDK cache
      - name: ğŸ“ Prepare SDK Cache Directory
        run: |
          mkdir -p $SDK_CACHE_DIR
          chmod 777 $SDK_CACHE_DIR

      # ğŸ’¾ Smart SDK caching
      - name: ğŸ’¾ Cache OpenWrt SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: ${{ env.SDK_CACHE_DIR }}
          key: sdk-${{ matrix.release }}-${{ matrix.arch }}-v2
          restore-keys: sdk-${{ matrix.release }}-

      # ğŸ“¦ Download and setup SDK
      - name: ğŸ“¦ Download and Setup OpenWrt SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          echo "::group::ğŸ“¦ Setting up OpenWrt SDK"
          
          RELEASE="${{ matrix.release }}"
          ARCH="${{ matrix.arch }}"

          # ğŸ¯ Configure release-specific parameters
          if [[ "$RELEASE" == "SNAPSHOT" ]]; then
            URL_PATH="snapshots/targets"
            GCC_VERSION="14.3.0"
            FILE_EXT="tar.zst"
            echo "ğŸ”¥ Using SNAPSHOT build - packages will be in APK format"
          elif [[ "$RELEASE" == "24.10.2" ]]; then
            URL_PATH="releases/24.10.2/targets"
            GCC_VERSION="13.3.0"
            FILE_EXT="tar.zst"
            echo "ğŸ“¦ Using stable release - packages will be in IPK format"
          elif [[ "$RELEASE" == "23.05.5" ]]; then
            URL_PATH="releases/23.05.5/targets"
            GCC_VERSION="12.3.0"
            FILE_EXT="tar.xz"
            echo "ğŸ“¦ Using stable release - packages will be in IPK format"
          fi

          # ğŸ¯ Architecture-specific configuration
          case "$ARCH" in
            "x86_64")
              TARGET="x86/64"
              SDK_PREFIX="x86-64"
              ;;
            "mips_24kc")
              TARGET="ath79/generic"
              SDK_PREFIX="ath79-generic"
              ;;
            "mipsel_24kc")
              TARGET="ramips/mt7621"
              SDK_PREFIX="ramips-mt7621"
              ;;
            "arm_cortex-a7_neon-vfpv4")
              TARGET="bcm27xx/bcm2709"
              SDK_PREFIX="bcm27xx-bcm2709"
              ;;
            "aarch64_cortex-a53")
              TARGET="bcm27xx/bcm2710"
              SDK_PREFIX="bcm27xx-bcm2710"
              ;;
            "aarch64_cortex-a72")
              TARGET="bcm27xx/bcm2711"
              SDK_PREFIX="bcm27xx-bcm2711"
              ;;
            "aarch64_generic")
              TARGET="rockchip/armv8"
              SDK_PREFIX="rockchip-armv8"
              ;;
          esac

          # ğŸ”— Build SDK name and URL
          if [[ "$RELEASE" == "SNAPSHOT" ]]; then
            SDK_NAME="openwrt-sdk-${SDK_PREFIX}_gcc-${GCC_VERSION}_musl"
            [[ "$ARCH" == "arm_cortex-a7_neon-vfpv4" ]] && SDK_NAME="${SDK_NAME}_eabi"
            SDK_NAME="${SDK_NAME}.Linux-x86_64"
          else
            SDK_NAME="openwrt-sdk-${RELEASE}-${SDK_PREFIX}_gcc-${GCC_VERSION}_musl"
            [[ "$ARCH" == "arm_cortex-a7_neon-vfpv4" ]] && SDK_NAME="${SDK_NAME}_eabi"
            SDK_NAME="${SDK_NAME}.Linux-x86_64"
          fi

          SDK_URL="https://downloads.openwrt.org/${URL_PATH}/${TARGET}/${SDK_NAME}.${FILE_EXT}"

          echo "ğŸŒ Downloading SDK from: $SDK_URL"
          wget -q "$SDK_URL" -O "$SDK_CACHE_DIR/sdk.${FILE_EXT}"

          echo "ğŸ“‚ Extracting SDK..."
          mkdir -p "$SDK_CACHE_DIR"
          
          # ğŸ—œï¸ Smart extraction based on file type
          if [[ "$FILE_EXT" == "tar.zst" ]]; then
            if command -v tar &> /dev/null && tar --use-compress-program=zstd -tf "$SDK_CACHE_DIR/sdk.tar.zst" >/dev/null 2>&1; then
              tar --use-compress-program=zstd -xf "$SDK_CACHE_DIR/sdk.tar.zst" -C "$SDK_CACHE_DIR"
            else
              zstd -d "$SDK_CACHE_DIR/sdk.${FILE_EXT}" -o "$SDK_CACHE_DIR/sdk.tar"
              tar -xf "$SDK_CACHE_DIR/sdk.tar" -C "$SDK_CACHE_DIR"
            fi
          else
            tar -xf "$SDK_CACHE_DIR/sdk.${FILE_EXT}" -C "$SDK_CACHE_DIR"
          fi

          mv "$SDK_CACHE_DIR/$SDK_NAME" "$SDK_CACHE_DIR/openwrt-sdk"
          echo "âœ… SDK setup completed"
          echo "::endgroup::"

      # ğŸ¯ Set SDK path
      - name: ğŸ¯ Configure SDK Path
        run: echo "SDK_PATH=${{ env.SDK_CACHE_DIR }}/openwrt-sdk" >> $GITHUB_ENV

      # ğŸ“‹ Read package list
      - name: ğŸ“‹ Discover Available Packages
        if: ${{ inputs.compile_pkg == '' }}
        id: list_package
        run: |
          echo "::group::ğŸ“‹ Scanning for packages"
          
          _packages=""
          _luci=""
          
          # ğŸ” Scan packages feed
          if [ -d "$GITHUB_WORKSPACE/feeds/packages" ]; then
            _packages="$(find $GITHUB_WORKSPACE/feeds/packages -mindepth 1 -maxdepth 2 -type d -name "*" | while read pkg_dir; do
              if [ -f "$pkg_dir/Makefile" ]; then
                basename "$pkg_dir"
              fi
            done | tr '\n' ' ' | sed 's/[[:space:]]*$//')"
          fi
          
          # ğŸ¨ Scan LuCI feed
          if [ -d "$GITHUB_WORKSPACE/feeds/luci" ]; then
            _luci="$(find $GITHUB_WORKSPACE/feeds/luci -mindepth 1 -maxdepth 2 -type d -name "*" | while read pkg_dir; do
              if [ -f "$pkg_dir/Makefile" ]; then
                basename "$pkg_dir"
              fi
            done | tr '\n' ' ' | sed 's/[[:space:]]*$//')"
          fi
          
          # ğŸ“Š Report findings
          if [ -z "$_packages" ]; then
            echo "âš ï¸ No packages found in feeds/packages"
          else
            echo "ğŸ“¦ Found packages: $_packages"
          fi
          
          if [ -z "$_luci" ]; then
            echo "âš ï¸ No LuCI packages found in feeds/luci"
          else
            echo "ğŸ¨ Found LuCI packages: $_luci"
          fi
          
          # ğŸ”„ Combine and deduplicate
          combined_packages="$_packages $_luci"
          combined_packages=$(echo "$combined_packages" | xargs -n1 | sort -u | xargs)
          
          echo "ğŸ“‹ Combined packages: $combined_packages"
          echo "content=$combined_packages" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      # ğŸ“„ Display compilation target
      - name: ğŸ“„ Display Compilation Targets
        run: |
          echo "ğŸ¯ **Compilation Targets**"
          echo "ğŸ“¦ Packages: ${{ steps.list_package.outputs.content }} ${{ inputs.compile_pkg }}"
          echo "ğŸ—ï¸ Architecture: ${{ matrix.arch }}"
          echo "ğŸ“‹ Release: ${{ matrix.release }}"

      # ğŸ“ Create artifact directory
      - name: ğŸ“ Prepare Artifact Directory
        run: mkdir -p artifacts

      # âš™ï¸ Setup SDK feeds
      - name: âš™ï¸ Configure SDK Feeds
        run: |
          echo "::group::âš™ï¸ Setting up SDK feeds"
          cd $SDK_PATH
          
          # ğŸ”— Configure default feeds
          if [ -z "$NO_DEFAULT_FEEDS" ]; then
            sed \
              -e 's,https://git.openwrt.org/feed/,https://github.com/openwrt/,' \
              -e 's,https://git.openwrt.org/openwrt/,https://github.com/openwrt/,' \
              -e 's,https://git.openwrt.org/project/,https://github.com/openwrt/,' \
              feeds.conf.default > feeds.conf
          fi
          
          # ğŸ“¦ Add custom feed
          FEEDNAME="custom"
          echo "src-link $FEEDNAME $GITHUB_WORKSPACE/feeds/" >> feeds.conf
          
          echo "ğŸ“‹ Feed configuration:"
          cat feeds.conf
          
          # ğŸ”„ Update and install feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "::endgroup::"

      # ğŸ“‚ Copy package sources
      - name: ğŸ“‚ Import Package Sources
        run: |
          echo "::group::ğŸ“‚ Importing package sources"
          cd $SDK_PATH
          if [ -d "$GITHUB_WORKSPACE/package" ]; then
            echo "ğŸ“¦ Copying root package directory..."
            cp -r $GITHUB_WORKSPACE/package/* ./package/ 2>/dev/null || true
            echo "âœ… Package sources imported"
          else
            echo "â„¹ï¸ No root package directory found"
          fi
          echo "::endgroup::"

      # âš™ï¸ Generate configuration
      - name: âš™ï¸ Generate Build Configuration
        run: |
          echo "::group::âš™ï¸ Generating build configuration"
          cd $SDK_PATH
          make defconfig
          echo "âœ… Default configuration generated"
          echo "::endgroup::"

      # ğŸ” Disable package signing
      - name: ğŸ” Configure Package Signing
        run: |
          echo "::group::ğŸ” Configuring package signing"
          cd $SDK_PATH
          echo "CONFIG_SIGNED_PACKAGES=n" >> .config
          make defconfig
          echo "âœ… Package signing disabled for faster builds"
          echo "::endgroup::"

      # ğŸ—ï¸ Build packages
      - name: ğŸ—ï¸ Compile Packages
        run: |
          echo "::group::ğŸ—ï¸ Starting package compilation"
          cd $SDK_PATH
          
          # ğŸ” Set verbosity level
          case "${{ inputs.verbose }}" in
            "1") V="V=s" ;;
            "2") V="V=sc" ;;
            *) V="" ;;
          esac
          
          # ğŸ“¦ Prepare package list
          PACKAGES="${{ steps.list_package.outputs.content }} ${{ inputs.compile_pkg }}"
          PACKAGES=$(echo $PACKAGES | xargs)
          echo "ğŸ¯ Building packages: $PACKAGES"
          
          # ğŸŒ Set build environment
          export BUILD_LOG=1
          export CONFIG_ALL_NONSHARED=n
          export CONFIG_ALL_KMODS=n
          export CONFIG_ALL=n
          export CONFIG_AUTOREMOVE=n
          export CONFIG_SIGNED_PACKAGES=n
          export FEEDNAME="custom"
          
          RET=0
          
          echo "::group::ğŸ“‹ Available packages in feeds"
          ./scripts/feeds list | grep -E "^(custom|base)" || echo "â„¹ï¸ No custom packages found in feeds"
          echo "::endgroup::"
          
          # ğŸ”¨ Build process
          if [ -n "$PACKAGES" ]; then
            for PKG in $PACKAGES; do
              echo "::group::ğŸ”¨ Building package: $PKG"
              ./scripts/feeds install -p "$FEEDNAME" -f "$PKG" || true
              
              if make -f .config -f tmp/.packagedeps -f <(echo "\$(info \$(sort \$(package-y) \$(package-m)))"; echo -en "a:\n\t@:") 2>/dev/null | tr ' ' '\n' | grep -qE "(^|/)$PKG$"; then
                echo "ğŸ—ï¸ Compiling $PKG..."
                if make package/$PKG/compile $V -j$(nproc); then
                  echo "âœ… Successfully built $PKG"
                  find bin/packages/ -name "*$PKG*" -type f 2>/dev/null || echo "â„¹ï¸ No package files found for $PKG"
                else
                  echo "âŒ Failed to build package: $PKG"
                  RET=1
                fi
              else
                echo "âš ï¸ Skipping $PKG (unsupported architecture or package not found)"
              fi
              echo "::endgroup::"
            done
          else
            echo "ğŸ—ï¸ Building all custom packages"
            ./scripts/feeds install -p "$FEEDNAME" -f -a
            make package/compile $V -j$(nproc) || RET=$?
          fi
          
          echo "::group::ğŸ“Š Build Results Summary"
          echo "ğŸ“¦ Packages in bin/packages/:"
          find bin/packages/ -name "*.ipk" -o -name "*.apk" 2>/dev/null | head -20 || echo "â„¹ï¸ No packages found"
          echo "::endgroup::"
          
          # ğŸ“‡ Create package index
          if [ "$RET" -eq 0 ]; then
            echo "::group::ğŸ“‡ Creating package index"
            if [ "${{ matrix.release }}" = "SNAPSHOT" ]; then
              make package/index -j1 V=s CONFIG_SIGNED_PACKAGES=n || echo "âš ï¸ APK package index creation failed"
            else
              make package/index -j1 V=s CONFIG_SIGNED_PACKAGES=n || echo "âš ï¸ IPK package index creation failed"
            fi
            echo "::endgroup::"
          fi
          
          echo "::endgroup::"
          exit $RET

      # ğŸ“¦ Copy built packages
      - name: ğŸ“¦ Collect Build Artifacts
        if: success() || failure()
        run: |
          echo "::group::ğŸ“¦ Collecting build artifacts"
          cd $SDK_PATH
          
          # ğŸ“ Create artifact directories
          mkdir -p $GITHUB_WORKSPACE/artifacts/bin/packages/${{ matrix.arch }}
          mkdir -p $GITHUB_WORKSPACE/artifacts/logs
          
          echo "::group::ğŸ” Debug - Directory Analysis"
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ” Checking for packages in bin/packages/${{ matrix.arch }}/"
          ls -la bin/packages/${{ matrix.arch }}/ 2>/dev/null || echo "â„¹ï¸ Directory bin/packages/${{ matrix.arch }}/ does not exist"
          echo "ğŸ” Searching for any packages in bin/packages/"
          find bin/packages/ -name "*.ipk" -o -name "*.apk" 2>/dev/null | head -10 || echo "â„¹ï¸ No packages found"
          echo "ğŸ—‚ï¸ Full bin directory structure:"
          find bin/ -type f -name "*.ipk" -o -name "*.apk" 2>/dev/null || echo "â„¹ï¸ No package files found in bin/"
          echo "::endgroup::"
          
          # ğŸ“¦ Copy packages
          echo "ğŸ“¦ Copying packages from architecture directory"
          if [ -d "./bin/packages/${{ matrix.arch }}/custom" ]; then
            echo "âœ… Found custom packages directory"
            cp -r ./bin/packages/${{ matrix.arch }}/custom/* $GITHUB_WORKSPACE/artifacts/bin/packages/${{ matrix.arch }}/ 2>/dev/null || true
          else
            echo "â„¹ï¸ No custom packages directory found"
          fi
          
          # ğŸ“‹ Copy logs
          if [ -d "./logs/package/feeds/custom" ]; then
            cp -r ./logs/package/feeds/custom/* $GITHUB_WORKSPACE/artifacts/logs/ 2>/dev/null || true
          fi
          
          if [ -d "./logs" ]; then
            find ./logs -name "*.log" -exec cp {} $GITHUB_WORKSPACE/artifacts/logs/ \; 2>/dev/null || true
          fi
          
          # ğŸ“Š Summary
          if [ "${{ matrix.release }}" = "SNAPSHOT" ]; then
            PKG_EXT="*.apk"
            PKG_TYPE="APK"
          else
            PKG_EXT="*.ipk" 
            PKG_TYPE="IPK"
          fi
          
          echo "ğŸ“¦ Built packages ($PKG_TYPE format):"
          find $GITHUB_WORKSPACE/artifacts -name "$PKG_EXT" -type f | head -20
          
          PKG_COUNT=$(find $GITHUB_WORKSPACE/artifacts -name "$PKG_EXT" -type f | wc -l)
          echo "ğŸ“Š Total $PKG_TYPE packages built: $PKG_COUNT"
          
          echo "ğŸ“‹ All package files found:"
          find $GITHUB_WORKSPACE/artifacts -name "*.ipk" -o -name "*.apk" | head -20
          
          echo "::group::ğŸ“‚ Final artifacts structure"
          find $GITHUB_WORKSPACE/artifacts -type f | head -20 || echo "â„¹ï¸ No artifacts found"
          echo "::endgroup::"
          echo "::endgroup::"

      # ğŸ“¤ Upload packages
      - name: ğŸ“¤ Upload Package Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwrt_${{ matrix.release }}_${{ matrix.arch }}
          path: ${{ github.workspace }}/artifacts/bin/packages/${{ matrix.arch }}/*
          retention-days: 30

      # ğŸ“‹ Upload build logs on failure
      - name: ğŸ“‹ Upload Build Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build_logs_${{ matrix.release }}_${{ matrix.arch }}
          path: ${{ github.workspace }}/artifacts/logs/*
          retention-days: 7

  # ğŸš€ Push packages to gh-pages
  push_packages:
    name: ğŸš€ Deploy Packages to Repository
    needs: build_ipk
    if: success() || failure()
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    steps:
      # ğŸ“¥ Checkout gh-pages branch
      - name: ğŸ“¥ Checkout Pages Branch
        uses: actions/checkout@v4
        with:
          ref: 'gh-pages'
          lfs: false
          submodules: false

      # ğŸ“¦ Download all artifacts
      - name: ğŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4

      # ğŸ§¹ Clean up logs
      - name: ğŸ§¹ Clean Build Logs
        run: sudo rm -rf build_logs*

      # ğŸ“ Organize packages by release
      - name: ğŸ“ Organize Package Structure
        shell: bash
        run: |
          echo "::group::ğŸ“ Organizing package structure"
          mkdir -p releases 2>/dev/null
          
          # ğŸ¯ Define supported versions and architectures
          version=( SNAPSHOT 24.10.2 23.05.5 )
          archi=( x86_64 mips_24kc mipsel_24kc arm_cortex-a7_neon-vfpv4 aarch64_cortex-a53 aarch64_cortex-a72 aarch64_generic )

          for vr in ${version[*]}; do
            # ğŸ“‹ Convert version format
            if [[ "$vr" == "SNAPSHOT" ]]; then
              vers="snapshot"
            else
              vers=$(echo $vr | sed 's/..$//')
            fi

            echo "ğŸ”„ Processing version: $vr -> $vers"

            for arc in ${archi[*]}; do
              artifact_dir="openwrt_${vr}_${arc}"
              
              if [ -d "$artifact_dir" ]; then
                echo "âœ… Processing $artifact_dir"
                rm -rf releases/$vers/packages/$arc
                mkdir -p releases/$vers/packages/$arc
                cp -rf $artifact_dir/* releases/$vers/packages/$arc/
                
                # ğŸ§¹ Remove unwanted directories
                rm -rf releases/$vers/packages/$arc/routing releases/$vers/packages/$arc/telephony
              else
                echo "âš ï¸ Artifact directory $artifact_dir not found"
              fi
            done
          done

          # ğŸ§¹ Clean up temporary artifacts
          rm -rf openwrt_* 2>/dev/null || true
          echo "::endgroup::"

      # ğŸ“‹ Display final structure
      - name: ğŸ“‹ Display Package Structure
        working-directory: releases
        run: |
          echo "::group::ğŸ“‹ Final package structure"
          ls -R
          echo "::endgroup::"

      # ğŸš€ Commit and push changes
      - name: ğŸš€ Commit and Push Changes
        env:
          Branch: gh-pages
        run: |
          echo "::group::ğŸš€ Publishing packages"
          git config --local user.name "ğŸ¤– GitHub Action"
          git config --local user.email "actions-user@users.noreply.github.com"
          git add .
          
          if ! git diff --staged --quiet; then
            git commit -m "ğŸš€ Update Packages - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "âœ… Packages published successfully"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
          echo "::endgroup::"

  # ğŸ“„ Build GitHub Pages
  build_pages:
    name: ğŸ“„ Build GitHub Pages
    needs: push_packages
    if: inputs.without_pages == false && !cancelled()
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    steps:
      # ğŸ“¥ Checkout pages branch
      - name: ğŸ“¥ Checkout Pages Branch
        uses: actions/checkout@v4
        with:
          ref: 'gh-pages'
          lfs: true
          submodules: true

      # ğŸ’ Setup Ruby environment
      - name: ğŸ’ Setup Ruby Environment
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
          cache-version: 0

      # âš™ï¸ Pre-processing script
      - name: âš™ï¸ Run Pre-processing
        env:
          SERVER_HOME: releases
        run: |
          echo "::group::âš™ï¸ Running pre-processing"
          if [ -f "./prenodes.sh" ]; then
            chmod +x ./prenodes.sh
            ./prenodes.sh
            echo "âœ… Pre-processing completed"
          else
            echo "â„¹ï¸ prenodes.sh not found, skipping"
          fi
          echo "::endgroup::"

      # ğŸ“„ Configure pages
      - name: ğŸ“„ Configure GitHub Pages
        id: pages
        uses: actions/configure-pages@v5

      # ğŸ—ï¸ Build with Jekyll
      - name: ğŸ—ï¸ Build Jekyll Site
        run: |
          echo "::group::ğŸ—ï¸ Building Jekyll site"
          bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
          echo "âœ… Jekyll site built successfully"
          echo "::endgroup::"
        env:
          JEKYLL_ENV: production

      # ğŸ“¤ Upload pages artifact
      - name: ğŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3

  # ğŸŒ Deploy to GitHub Pages
  deploy:
    name: ğŸŒ Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-22.04
    needs: build_pages
    if: inputs.without_pages == false && !cancelled()
    
    steps:
      # ğŸš€ Deploy to GitHub Pages
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ğŸ§¹ Cleanup artifacts and old runs
  clear_artifact:
    name: ğŸ§¹ Cleanup Workflow Artifacts
    needs: push_packages
    if: always()
    runs-on: ubuntu-22.04
    permissions:
      actions: write
      contents: read
    
    steps:
      # ğŸ—‘ï¸ Clean old workflow runs
      - name: ğŸ—‘ï¸ Clean Old Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 5
          keep_minimum_runs: 2