# Copyright (C) 2025 rtaserver-wrt
#
name: AutoCompiler OpenWrt Packages

on:
  workflow_run:
    workflows: ["Auto Sync App"]
    types:
      - completed

  push:
    branches:
      - main
    paths-ignore:
      - '.github/workflows/**'
      - 'README.md'

  workflow_dispatch:
    inputs:
      release:
        description: 'Build for a specific release. Leave empty to build for all.'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - 'SNAPSHOT'
          - '24.10.2'
          - '23.05.5'
      arch:
        description: 'Build for a specific arch (e.g., x86_64, aarch64_cortex-a53). Leave empty to build for all.'
        required: false
        default: ''
        type: string
      compile_pkg:
        description: 'Compile specific packages (space-separated). Default: all in feeds.'
        required: false
        default: ''
        type: string
      verbose:
        description: 'Verbose build output'
        required: false
        default: '0'
        type: choice
        options:
          - '0' # No verbose
          - '1' # V=s
          - '2' # V=sc
      without_pages:
        description: 'Do not build and deploy GitHub Pages'
        required: true
        default: false
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: auto-compiler-${{ github.ref }}
  cancel-in-progress: true

env:
  TZ: Asia/Jakarta

jobs:
  build_ipk:
    permissions:
      contents: write
    name: ğŸ—ï¸ Build Packages [${{ matrix.release }}-${{ matrix.arch }}]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        release: ${{ fromJSON(inputs.release && format('["{0}"]', inputs.release) || '["SNAPSHOT", "24.10.2", "23.05.5"]') }}
        arch: ${{ fromJSON(inputs.arch && format('["{0}"]', inputs.arch) || '["x86_64", "mips_24kc", "mipsel_24kc", "arm_cortex-a7_neon-vfpv4", "aarch64_cortex-a53", "aarch64_cortex-a72", "aarch64_generic"]') }}

    env:
      SDK_CACHE_DIR: ${{ github.workspace }}/sdk_cache

    steps:
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ› ï¸ Install System Dependencies
        run: |
          echo "::group::ğŸ”§ Cleaning system and installing dependencies"
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d /usr/local/lib/android
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-distutils python3-setuptools rsync swig unzip zlib1g-dev \
            file wget zstd python3-pyelftools curl jq
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          echo "::endgroup::"

      - name: âš™ï¸ Prepare SDK Environment
        run: |
          echo "::group::ğŸ“‚ Setting up SDK Cache Directory"
          mkdir -p $SDK_CACHE_DIR
          chmod 777 $SDK_CACHE_DIR
          echo "SDK Cache Directory: $SDK_CACHE_DIR"
          
          # Create resuildpackages directory early
          mkdir -p $GITHUB_WORKSPACE/resuildpackages
          echo "::endgroup::"

      - name: ğŸ“¦ Cache OpenWrt SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: ${{ env.SDK_CACHE_DIR }}/openwrt-sdk
          key: sdk-${{ runner.os }}-${{ matrix.release }}-${{ matrix.arch }}-v4
          restore-keys: |
            sdk-${{ runner.os }}-${{ matrix.release }}-
            sdk-${{ runner.os }}-

      - name: ğŸ“¥ Download and Setup OpenWrt SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          RELEASE="${{ matrix.release }}"
          ARCH="${{ matrix.arch }}"
          
          echo "::group::âš™ï¸ SDK Configuration for Release: $RELEASE, Arch: $ARCH"
          
          # Configure SDK parameters based on release
          if [[ "$RELEASE" == "SNAPSHOT" ]]; then
            URL_PATH="snapshots/targets"
            GCC_VERSION="14.3.0"
            FILE_EXT="tar.zst"
            echo "ğŸ“¦ Using SNAPSHOT build"
          elif [[ "$RELEASE" == "24.10.2" ]]; then
            URL_PATH="releases/24.10.2/targets"
            GCC_VERSION="13.3.0"
            FILE_EXT="tar.zst"
            echo "ğŸ“¦ Using stable release 24.10.2"
          elif [[ "$RELEASE" == "23.05.5" ]]; then
            URL_PATH="releases/23.05.5/targets"
            GCC_VERSION="12.3.0"
            FILE_EXT="tar.xz"
            echo "ğŸ“¦ Using stable release 23.05.5"
          fi
          
          # Map architecture to target
          case "$ARCH" in
            "x86_64") TARGET="x86/64" ;;
            "mips_24kc") TARGET="ath79/generic" ;;
            "mipsel_24kc") TARGET="ramips/mt7621" ;;
            "arm_cortex-a7_neon-vfpv4") TARGET="bcm27xx/bcm2709" ;;
            "aarch64_cortex-a53") TARGET="bcm27xx/bcm2710" ;;
            "aarch64_cortex-a72") TARGET="bcm27xx/bcm2711" ;;
            "aarch64_generic") TARGET="rockchip/armv8" ;;
            *) echo "âŒ Unsupported architecture: $ARCH"; exit 1 ;;
          esac
          
          SDK_FLAVOR=$(echo $TARGET | tr '/' '-')
          SDK_SUFFIX_EABI=$(if [[ "$ARCH" =~ arm_cortex ]]; then echo "_eabi"; fi)
          
          if [[ "$RELEASE" == "SNAPSHOT" ]]; then
            SDK_NAME="openwrt-sdk-${SDK_FLAVOR}_gcc-${GCC_VERSION}_musl${SDK_SUFFIX_EABI}.Linux-x86_64"
          else
            SDK_NAME="openwrt-sdk-${RELEASE}-${SDK_FLAVOR}_gcc-${GCC_VERSION}_musl${SDK_SUFFIX_EABI}.Linux-x86_64"
          fi
          
          SDK_URL="https://downloads.openwrt.org/${URL_PATH}/${TARGET}/${SDK_NAME}.${FILE_EXT}"
          echo "SDK URL: $SDK_URL"
          echo "::endgroup::"
          
          echo "::group::ğŸ“¥ Downloading SDK"
          # Retry logic with exponential backoff
          for i in {1..5}; do
            if wget -q --timeout=60 --tries=1 "$SDK_URL" -O "$SDK_CACHE_DIR/sdk.${FILE_EXT}"; then
              echo "âœ… SDK downloaded successfully on attempt $i"
              break
            else
              if [ $i -eq 5 ]; then
                echo "âŒ Failed to download SDK after 5 attempts"
                echo "::error::Unable to download SDK from $SDK_URL"
                exit 1
              fi
              echo "âš ï¸ Download attempt $i failed, retrying in $((i * 10)) seconds..."
              sleep $((i * 10))
            fi
          done
          echo "::endgroup::"
          
          echo "::group::ğŸ“¦ Extracting SDK"
          mkdir -p "$SDK_CACHE_DIR/openwrt-sdk"
          if [[ "$FILE_EXT" == "tar.zst" ]]; then
            if ! tar --use-compress-program=zstd -xf "$SDK_CACHE_DIR/sdk.${FILE_EXT}" --strip-components=1 -C "$SDK_CACHE_DIR/openwrt-sdk"; then
              echo "âŒ Failed to extract SDK (zstd)"
              exit 1
            fi
          else
            if ! tar -xf "$SDK_CACHE_DIR/sdk.${FILE_EXT}" --strip-components=1 -C "$SDK_CACHE_DIR/openwrt-sdk"; then
              echo "âŒ Failed to extract SDK (tar)"
              exit 1
            fi
          fi
          rm "$SDK_CACHE_DIR/sdk.${FILE_EXT}"
          echo "âœ… SDK extracted to $SDK_CACHE_DIR/openwrt-sdk"
          echo "::endgroup::"

      - name: ğŸ“¦ Cache OpenWrt dl Directory
        id: cache-dl
        uses: actions/cache@v4
        with:
          path: ${{ env.SDK_CACHE_DIR }}/openwrt-sdk/dl
          key: dl-${{ runner.os }}-${{ matrix.release }}-${{ matrix.arch }}-v4
          restore-keys: |
            dl-${{ runner.os }}-${{ matrix.release }}-
            dl-${{ runner.os }}-

      - name: ğŸ› ï¸ Setup Custom Feeds
        run: |
          echo "::group::ğŸ“¦ Preparing Custom Feeds"
          mkdir -p "$GITHUB_WORKSPACE/feeds/custom"
          
          # Migrate packages from luci and packages to custom
          for source_dir in "$GITHUB_WORKSPACE/feeds/luci" "$GITHUB_WORKSPACE/feeds/packages"; do
            if [ -d "$source_dir" ]; then
              echo "ğŸ“ Migrating packages from $(basename "$source_dir")..."
              for dir in "$source_dir"/*; do
                [ -d "$dir" ] || continue
                pkg_name=$(basename "$dir")
                target_dir="$GITHUB_WORKSPACE/feeds/custom/$pkg_name"
                
                # Only copy if doesn't exist in custom
                if [ ! -d "$target_dir" ]; then
                  cp -r "$dir" "$target_dir"
                  echo "  âœ… Migrated: $pkg_name"
                else
                  echo "  âš ï¸ Skipped (exists): $pkg_name"
                fi
              done
            fi
          done
          
          echo "ğŸ“¦ Custom feeds preparation completed"
          echo "::endgroup::"

      - name: ğŸ› ï¸ Setup SDK Feeds and Configuration
        run: |
          cd ${{ env.SDK_CACHE_DIR }}/openwrt-sdk
          
          echo "::group::ğŸ“œ Configuring Feeds"
          # Determine branch for feeds
          if [[ "${{ matrix.release }}" == "SNAPSHOT" ]]; then
            FEED_BRANCH="master"
          elif [[ "${{ matrix.release }}" == "24.10.2" ]]; then
            FEED_BRANCH="openwrt-24.10"
          elif [[ "${{ matrix.release }}" == "23.05.5" ]]; then
            FEED_BRANCH="openwrt-23.05"
          else
            FEED_BRANCH="master"
          fi
          
          # Create feeds.conf with correct branch
          cat > feeds.conf << EOF
          src-git base https://github.com/openwrt/openwrt.git;${FEED_BRANCH}
          src-git packages https://github.com/openwrt/packages.git;${FEED_BRANCH}
          src-git luci https://github.com/openwrt/luci.git;${FEED_BRANCH}
          src-git routing https://git.openwrt.org/feed/routing.git;${FEED_BRANCH}
          src-link custom $GITHUB_WORKSPACE/feeds/custom
          EOF
          
          echo "Feeds configuration:"
          cat feeds.conf
          echo "::endgroup::"
          
          echo "::group::ğŸ”„ Updating and Installing Feeds"
          # Update feeds with error handling
          if ! ./scripts/feeds update -a; then
            echo "âš ï¸ Some feeds failed to update. Checking logs..."
            find logs/feeds -name "*.log" 2>/dev/null | head -5 | while read log; do
              echo "--- Error in $log ---"
              tail -20 "$log" || true
              echo "---"
            done
            echo "Continuing with installation..."
          fi
          
          # Install feeds
          if ! ./scripts/feeds install -a; then
            echo "âŒ Failed to install feeds"
            ./scripts/feeds list | head -20
            exit 1
          fi
          
          # Upgrade golang if available
          if [ -d "feeds/packages/lang/golang" ]; then
            echo "ğŸ”§ Updating golang to latest version"
            rm -rf feeds/packages/lang/golang
            if ! git clone https://github.com/sbwml/packages_lang_golang -b 24.x feeds/packages/lang/golang; then
              echo "âš ï¸ Failed to clone golang, using default"
            fi
          fi
          echo "::endgroup::"
          
          echo "::group::ğŸ“ Generating Build Configuration"
          cat > .config << EOF
          CONFIG_ALL_NONSHARED=n
          CONFIG_ALL_KMODS=n
          CONFIG_ALL=n
          CONFIG_AUTOREMOVE=n
          CONFIG_SIGNED_PACKAGES=n
          CONFIG_BUILDBOT=y
          CONFIG_DEVEL=y
          CONFIG_CCACHE=y
          EOF
          
          if ! make defconfig; then
            echo "âŒ Failed to generate default configuration"
            exit 1
          fi
          echo "âœ… Default configuration generated"
          echo "::endgroup::"

      - name: ğŸ“‹ Determine Packages to Build
        id: determine_packages
        run: |
          cd ${{ env.SDK_CACHE_DIR }}/openwrt-sdk
          
          if [[ -n "${{ inputs.compile_pkg }}" ]]; then
            PACKAGES="${{ inputs.compile_pkg }}"
            echo "ğŸ“¦ Building specific packages: $PACKAGES"
          else
            PACKAGES=""
            # Find custom packages
            if [ -d "$GITHUB_WORKSPACE/feeds/custom" ]; then
              echo "ğŸ” Scanning custom feeds..."
              for makefile in $GITHUB_WORKSPACE/feeds/custom/*/Makefile; do
                [ -f "$makefile" ] || continue
                pkg_dir=$(dirname "$makefile")
                pkg_name=$(basename "$pkg_dir")
                
                # Verify it's a valid package
                if grep -q "PKG_NAME\|Package:" "$makefile" 2>/dev/null; then
                  PACKAGES="$PACKAGES $pkg_name"
                fi
              done
            fi
            
            # Fallback to all available packages if no custom packages
            if [ -z "$(echo $PACKAGES | xargs)" ]; then
              echo "ğŸ“¦ No custom packages found, building all available packages"
              PACKAGES="all"
            fi
          fi
          
          PACKAGES=$(echo "$PACKAGES" | xargs -n1 | sort -u | xargs)
          echo "ğŸ“¦ Final packages to build: $PACKAGES"
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ Download Sources
        run: |
          cd ${{ env.SDK_CACHE_DIR }}/openwrt-sdk
          echo "::group::ğŸ“¥ Downloading package sources"
          
          # Download with retry logic
          if ! make download -j8; then
            echo "âš ï¸ Parallel download failed, trying sequential..."
            if ! make download -j1 V=s; then
              echo "âŒ Failed to download sources"
              exit 1
            fi
          fi
          
          # Check for corrupted downloads
          corrupted_files=$(find dl -size -1024c 2>/dev/null | wc -l)
          if [ $corrupted_files -gt 0 ]; then
            echo "âš ï¸ Found $corrupted_files potentially corrupted files"
            find dl -size -1024c -exec ls -l {} \;
          fi
          echo "::endgroup::"

      - name: ğŸ”¨ Build Packages
        run: |
          cd ${{ env.SDK_CACHE_DIR }}/openwrt-sdk
          
          # Set verbosity
          V_FLAG=""
          case "${{ inputs.verbose }}" in
            "1") V_FLAG="V=s" ;;
            "2") V_FLAG="V=sc" ;;
          esac
          
          PACKAGES="${{ steps.determine_packages.outputs.packages }}"
          BUILD_SUCCESS=true
          FAILED_PACKAGES=""
          SUCCESSFUL_PACKAGES=""
          
          echo "::group::ğŸ”¨ Building Packages"
          
          if [ "$PACKAGES" = "all" ]; then
            echo "ğŸ“¦ Building all available packages..."
            if ! make package/compile $V_FLAG -j$(nproc); then
              echo "âš ï¸ Some packages failed with parallel build, trying sequential..."
              if ! make package/compile $V_FLAG -j1; then
                BUILD_SUCCESS=false
              fi
            fi
          else
            # Build specific packages
            for PKG in $PACKAGES; do
              echo "::group::ğŸ“¦ Building Package: $PKG"
              
              # Check if package exists
              PKG_FOUND=false
              for FEED_PATH in feeds/custom feeds/packages feeds/luci feeds/routing package; do
                if [ -d "$FEED_PATH/$PKG" ]; then
                  PKG_FOUND=true
                  echo "âœ… Found package $PKG in $FEED_PATH"
                  
                  # Try parallel build first, then sequential
                  if make package/$PKG/compile $V_FLAG -j$(nproc); then
                    echo "âœ… Successfully built package: $PKG"
                    SUCCESSFUL_PACKAGES="$SUCCESSFUL_PACKAGES $PKG"
                  elif make package/$PKG/compile $V_FLAG -j1; then
                    echo "âœ… Successfully built package: $PKG (sequential)"
                    SUCCESSFUL_PACKAGES="$SUCCESSFUL_PACKAGES $PKG"
                  else
                    echo "âŒ Failed to build package: $PKG"
                    FAILED_PACKAGES="$FAILED_PACKAGES $PKG"
                    BUILD_SUCCESS=false
                  fi
                  break
                fi
              done
              
              if [ "$PKG_FOUND" = "false" ]; then
                echo "âŒ Package $PKG not found in any feed"
                FAILED_PACKAGES="$FAILED_PACKAGES $PKG"
                BUILD_SUCCESS=false
              fi
              echo "::endgroup::"
            done
          fi
          
          echo "::endgroup::"
          
          # Summary
          if [ -n "$SUCCESSFUL_PACKAGES" ]; then
            echo "âœ… Successfully built packages: $SUCCESSFUL_PACKAGES"
          fi
          if [ -n "$FAILED_PACKAGES" ]; then
            echo "::warning::Failed to build packages: $FAILED_PACKAGES"
          fi
          
          # Set outputs
          echo "successful_packages=$SUCCESSFUL_PACKAGES" >> $GITHUB_OUTPUT
          echo "failed_packages=$FAILED_PACKAGES" >> $GITHUB_OUTPUT

      - name: ğŸ—‚ï¸ Collect and Move Packages
        if: always()
        run: |
          echo "::group::ğŸ—‚ï¸ Collecting Built Packages"
          cd ${{ env.SDK_CACHE_DIR }}/openwrt-sdk
          
          PACKAGES_TO_COLLECT="${{ steps.determine_packages.outputs.packages }}"
          PACKAGE_COUNT=0
          
          # Find and collect packages
          if [ "$PACKAGES_TO_COLLECT" = "all" ]; then
            # Collect all built packages
            find bin/packages -type f \( -name "*.ipk" -o -name "*.apk" \) -exec cp {} "$GITHUB_WORKSPACE/resuildpackages/" \; 2>/dev/null || true
            PACKAGE_COUNT=$(find "$GITHUB_WORKSPACE/resuildpackages/" -name "*.ipk" -o -name "*.apk" | wc -l)
          else
            # Collect specific packages and their dependencies
            for PKG in $PACKAGES_TO_COLLECT; do
              # Find package files
              find bin/packages -type f \( -name "${PKG}_*.ipk" -o -name "${PKG}_*.apk" \) -exec cp {} "$GITHUB_WORKSPACE/resuildpackages/" \; 2>/dev/null || true
            done
            PACKAGE_COUNT=$(find "$GITHUB_WORKSPACE/resuildpackages/" -name "*.ipk" -o -name "*.apk" | wc -l)
          fi
          
          # Copy package indices
          find bin/packages -name "Packages*" -exec cp {} "$GITHUB_WORKSPACE/resuildpackages/" \; 2>/dev/null || true
          
          echo "ğŸ“¦ Collected $PACKAGE_COUNT packages"
          echo "âœ¨ Final package structure:"
          ls -la "$GITHUB_WORKSPACE/resuildpackages/" || echo "No packages found"
          echo "::endgroup::"

      - name: ğŸ“¤ Upload Packages Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-packages-${{ matrix.release }}-${{ matrix.arch }}
          path: ${{ github.workspace }}/resuildpackages/
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ“¤ Upload Build Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.release }}-${{ matrix.arch }}
          path: ${{ env.SDK_CACHE_DIR }}/openwrt-sdk/logs/
          retention-days: 14
          if-no-files-found: ignore

  push_packages:
    needs: build_ipk
    if: always() && needs.build_ipk.result != 'cancelled'
    name: ğŸš€ Push Packages to gh-pages
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸš€ Checkout gh-pages Branch
        uses: actions/checkout@v4
        with:
          ref: 'gh-pages'
          fetch-depth: 1

      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: openwrt-packages-*
          merge-multiple: false

      - name: ğŸ“‚ Organize Packages
        run: |
          echo "::group::ğŸ“‚ Organizing packages into release directories"
          
          TOTAL_PACKAGES=0
          RELEASES_UPDATED=""
          
          for dir in ./artifacts/openwrt-packages-*; do
            if [ -d "$dir" ] && [ "$(ls -A "$dir" 2>/dev/null)" ]; then
              # Extract release and arch from directory name
              DIR_NAME=$(basename "$dir")
              RELEASE=$(echo "$DIR_NAME" | sed 's/openwrt-packages-//' | cut -d'-' -f1)
              ARCH=$(echo "$DIR_NAME" | sed 's/openwrt-packages-[^-]*-//')
              
              # Determine target directory
              if [[ "$RELEASE" == "SNAPSHOT" ]]; then
                TARGET_DIR="releases/snapshot/packages/$ARCH"
              else
                VERSION_MAJOR=$(echo "$RELEASE" | cut -d'.' -f1-2)
                TARGET_DIR="releases/$VERSION_MAJOR/packages/$ARCH"
              fi
              
              echo "ğŸ“¦ Processing packages from $dir to $TARGET_DIR"
              mkdir -p "$TARGET_DIR"
              
              # Count packages before moving
              PKG_COUNT=$(find "$dir" -name "*.ipk" -o -name "*.apk" | wc -l)
              if [ $PKG_COUNT -gt 0 ]; then
                echo "   Found $PKG_COUNT packages for $RELEASE-$ARCH"
                TOTAL_PACKAGES=$((TOTAL_PACKAGES + PKG_COUNT))
                RELEASES_UPDATED="$RELEASES_UPDATED $RELEASE-$ARCH"
                
                # Move files
                rsync -av "$dir/" "$TARGET_DIR/"
              else
                echo "   No packages found for $RELEASE-$ARCH"
              fi
            else
              echo "âš ï¸ Empty or missing directory: $dir"
            fi
          done
          
          # Clean up artifact directories
          rm -rf ./artifacts
          
          echo "âœ… Total packages processed: $TOTAL_PACKAGES"
          echo "ğŸ“‹ Releases updated: $RELEASES_UPDATED"
          
          # Store for commit message
          echo "TOTAL_PACKAGES=$TOTAL_PACKAGES" >> $GITHUB_ENV
          echo "RELEASES_UPDATED=$RELEASES_UPDATED" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: ğŸ’¾ Commit and Push Changes
        run: |
          git config --local user.name "GitHub Action Bot"
          git config --local user.email "actions-user@users.noreply.github.com"
          
          # Add changes
          git add releases/ || true
          
          # Check if there are changes to commit
          if ! git diff --staged --quiet; then
            COMMIT_MSG="ğŸš€ Update Packages (${{ env.TOTAL_PACKAGES }} total) - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            if [ -n "${{ env.RELEASES_UPDATED }}" ]; then
              COMMIT_MSG="$COMMIT_MSG Updated releases:${{ env.RELEASES_UPDATED }}"
            else
              COMMIT_MSG="$COMMIT_MSG No specific releases updated"
            fi
            
            if git commit -m "$COMMIT_MSG"; then
              # Push with retry logic
              for i in {1..3}; do
                if git push origin gh-pages; then
                  echo "âœ… Successfully pushed package updates on attempt $i"
                  break
                else
                  if [ $i -eq 3 ]; then
                    echo "âŒ Failed to push after 3 attempts"
                    exit 1
                  fi
                  echo "âš ï¸ Push attempt $i failed, retrying in 5 seconds..."
                  sleep 5
                fi
              done
            else
              echo "âŒ Failed to commit changes"
              git status
              exit 1
            fi
          else
            echo "âœ… No new packages to commit"
          fi

  build_and_deploy_pages:
    needs: push_packages
    if: inputs.without_pages == false && (success() || failure())
    name: ğŸŒ Deploy to GitHub Pages
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸš€ Checkout gh-pages Branch
        uses: actions/checkout@v4
        with:
          ref: 'gh-pages'
          submodules: true

      - name: ğŸ’ Setup Ruby and Jekyll
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: ğŸ“œ Run Pre-build Script
        env:
          SERVER_HOME: releases
        run: |
          if [ -f "./prenodes.sh" ]; then
            echo "ğŸ”§ Running prenodes.sh..."
            chmod +x ./prenodes.sh
            ./prenodes.sh
          else
            echo "â„¹ï¸ prenodes.sh not found, skipping"
          fi

      - name: ğŸ› ï¸ Configure GitHub Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: ğŸ—ï¸ Build with Jekyll
        run: bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: production

      - name: ğŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4