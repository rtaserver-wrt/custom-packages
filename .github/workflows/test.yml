# Copyright (C) 2025 rtaserver-wrt
#
name: AutoCompiler OpenWrt Packages

on:
  workflow_run:
    workflows: ["Auto Sync App"]
    types:
      - completed

  push:
    branches:
      - main
    paths-ignore:
      - '.github/workflows/**'
      - 'README.md'

  workflow_dispatch:
    inputs:
      release:
        description: 'Build for a specific release. Leave empty to build for all.'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - 'SNAPSHOT'
          - '24.10.2'
          - '23.05.5'

      arch:
        description: 'Build for a specific arch (e.g., x86_64, aarch64_cortex-a53). Leave empty to build for all.'
        required: false
        default: ''
        type: string
      compile_pkg:
        description: 'Compile specific packages (space-separated). Default: all in feeds.'
        required: false
        default: ''
        type: string
      verbose:
        description: 'Verbose build output'
        required: false
        default: '0'
        type: choice
        options:
          - '0' # No verbose
          - '1' # V=s
          - '2' # V=sc
      without_pages:
        description: 'Do not build and deploy GitHub Pages'
        required: true
        default: false
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: auto-compiler-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_ipk:
    permissions:
      contents: write
    name: ğŸ—ï¸ Build Packages
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        release: ${{ fromJSON(inputs.release && format('["{0}"]', inputs.release) || '["SNAPSHOT", "24.10.2", "23.05.5"]') }}
        arch: ${{ fromJSON(inputs.arch && format('["{0}"]', inputs.arch) || '["x86_64", "mips_24kc", "mipsel_24kc", "arm_cortex-a7_neon-vfpv4", "aarch64_cortex-a53", "aarch64_cortex-a72", "aarch64_generic"]') }}

    env:
      SDK_CACHE_DIR: ${{ github.workspace }}/sdk_cache

    steps:
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Install System Dependencies
        run: |
          echo "::group:: Apt Cache & Dependencies Installation"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools rsync swig unzip zlib1g-dev file wget zstd python3-pyelftools
          sudo pip3 install --upgrade pip
          sudo pip3 install meson ninja
          echo "::endgroup::"

      - name: âš™ï¸ Prepare SDK Environment
        run: |
          echo "::group:: Setting up SDK Cache Directory"
          mkdir -p $SDK_CACHE_DIR
          chmod 777 $SDK_CACHE_DIR
          echo "SDK Cache Directory: $SDK_CACHE_DIR"
          echo "::endgroup::"
      
      - name: ğŸ“¦ Cache OpenWrt SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: ${{ env.SDK_CACHE_DIR }}/openwrt-sdk
          key: sdk-${{ runner.os }}-${{ matrix.release }}-${{ matrix.arch }}

      - name: ğŸ“¥ Download and Setup OpenWrt SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          RELEASE="${{ matrix.release }}"
          ARCH="${{ matrix.arch }}"
          
          echo "::group:: âš™ï¸ SDK Configuration for Release: $RELEASE, Arch: $ARCH"
          
          if [[ "$RELEASE" == "SNAPSHOT" ]]; then
            URL_PATH="snapshots/targets"
            GCC_VERSION="14.3.0"
            FILE_EXT="tar.zst"
            echo "ğŸ“¦ Using SNAPSHOT build. Packages will be in APK format."
          elif [[ "$RELEASE" == "24.10.2" ]]; then
            URL_PATH="releases/24.10.2/targets"
            GCC_VERSION="13.3.0"
            FILE_EXT="tar.zst"
            echo "ğŸ“¦ Using stable release 24.10.2. Packages will be in IPK format."
          elif [[ "$RELEASE" == "23.05.5" ]]; then
            URL_PATH="releases/23.05.5/targets"
            GCC_VERSION="12.3.0"
            FILE_EXT="tar.xz"
            echo "ğŸ“¦ Using stable release 23.05.5. Packages will be in IPK format."
          fi

          case "$ARCH" in
            "x86_64") TARGET="x86/64" ;;
            "mips_24kc") TARGET="ath79/generic" ;;
            "mipsel_24kc") TARGET="ramips/mt7621" ;;
            "arm_cortex-a7_neon-vfpv4") TARGET="bcm27xx/bcm2709" ;;
            "aarch64_cortex-a53") TARGET="bcm27xx/bcm2710" ;;
            "aarch64_cortex-a72") TARGET="bcm27xx/bcm2711" ;;
            "aarch64_generic") TARGET="rockchip/armv8" ;;
          esac

          SDK_FLAVOR=$(echo $TARGET | tr '/' '-')
          SDK_SUFFIX_EABI=$(if [[ "$ARCH" == "arm_cortex-a7_neon-vfpv4" ]]; then echo "_eabi"; fi)
          
          if [[ "$RELEASE" == "SNAPSHOT" ]]; then
            SDK_NAME="openwrt-sdk-${SDK_FLAVOR}_gcc-${GCC_VERSION}_musl${SDK_SUFFIX_EABI}.Linux-x86_64"
          else
            SDK_NAME="openwrt-sdk-${RELEASE}-${SDK_FLAVOR}_gcc-${GCC_VERSION}_musl${SDK_SUFFIX_EABI}.Linux-x86_64"
          fi
          
          SDK_URL="https://downloads.openwrt.org/${URL_PATH}/${TARGET}/${SDK_NAME}.${FILE_EXT}"

          echo "::endgroup::"

          echo "::group:: ğŸ“¥ Downloading SDK"
          echo "Downloading from: $SDK_URL"
          wget -q "$SDK_URL" -O "$SDK_CACHE_DIR/sdk.${FILE_EXT}"
          echo "âœ… SDK downloaded."
          echo "::endgroup::"
          
          echo "::group:: ğŸ“¦ Extracting SDK"
          mkdir -p "$SDK_CACHE_DIR/openwrt-sdk"
          if [[ "$FILE_EXT" == "tar.zst" ]]; then
            tar --use-compress-program=zstd -xf "$SDK_CACHE_DIR/sdk.${FILE_EXT}" --strip-components=1 -C "$SDK_CACHE_DIR/openwrt-sdk"
          else
            tar -xf "$SDK_CACHE_DIR/sdk.${FILE_EXT}" --strip-components=1 -C "$SDK_CACHE_DIR/openwrt-sdk"
          fi
          echo "âœ… SDK extracted to $SDK_CACHE_DIR/openwrt-sdk"
          echo "::endgroup::"
        
      - name: ğŸ“‚ Set SDK Path
        run: echo "SDK_PATH=${{ env.SDK_CACHE_DIR }}/openwrt-sdk" >> $GITHUB_ENV

      - name: ğŸ“‹ Read Package List from Feeds
        if: ${{ inputs.compile_pkg == '' }}
        id: list_package
        run: |
          echo "::group::ğŸ“‹ Reading package list"
          find_packages() {
            local feed_dir="$1"
            if [ -d "$feed_dir" ]; then
              find "$feed_dir" -mindepth 1 -maxdepth 2 -type f -name "Makefile" -exec dirname {} \; | xargs -n1 basename | tr '\n' ' '
            fi
          }
          
          packages=$(find_packages "$GITHUB_WORKSPACE/feeds/packages")
          luci_packages=$(find_packages "$GITHUB_WORKSPACE/feeds/luci")
          
          echo "ğŸ“¦ Found packages: ${packages:-None}"
          echo "ğŸ¨ Found LuCI packages: ${luci_packages:-None}"
          
          combined_packages=$(echo "$packages $luci_packages" | xargs -n1 | sort -u | xargs)
          echo "âœ¨ Combined unique packages: $combined_packages"
          echo "::endgroup::"
          echo "content=$combined_packages" >> $GITHUB_OUTPUT

      - name: ğŸ“œ List Packages to Compile
        run: |
          echo "::group::ğŸ“¦ Packages to be compiled"
          echo "${{ steps.list_package.outputs.content }} ${{ inputs.compile_pkg }}"
          echo "::endgroup::"

      - name: ğŸ“¦ Cache OpenWrt dl Directory
        id: cache-dl
        uses: actions/cache@v4
        with:
          path: ${{ env.SDK_CACHE_DIR }}/openwrt-sdk/dl
          key: dl-${{ runner.os }}-${{ matrix.release }}-${{ matrix.arch }}

      - name: ğŸ› ï¸ Setup SDK Feeds and Configuration
        run: |
          cd $SDK_PATH
          echo "::group::ğŸ“œ Configuring Feeds"
          cp feeds.conf.default feeds.conf
          echo "src-link custom $GITHUB_WORKSPACE/feeds" >> feeds.conf
          echo "Feeds configuration:"
          cat feeds.conf
          echo "::endgroup::"
          
          echo "::group::ğŸ”„ Updating and Installing Feeds"
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "::endgroup::"

          echo "::group::ğŸ“ Generating Build Configuration"
          if [ -d "$GITHUB_WORKSPACE/package" ]; then
            echo "Copying custom package sources..."
            cp -r $GITHUB_WORKSPACE/package/* ./package/ 2>/dev/null || true
          fi
          make defconfig
          echo "CONFIG_SIGNED_PACKAGES=n" >> .config
          make defconfig
          echo "âœ… Default configuration generated."
          echo "::endgroup::"

      - name: ğŸ“¦ Build Packages
        run: |
          cd $SDK_PATH
          V_FLAG=""
          if [ "${{ inputs.verbose }}" = "1" ]; then V_FLAG="V=s"; fi
          if [ "${{ inputs.verbose }}" = "2" ]; then V_FLAG="V=sc"; fi

          PACKAGES_TO_BUILD="${{ steps.list_package.outputs.content }} ${{ inputs.compile_pkg }}"
          PACKAGES_TO_BUILD=$(echo "$PACKAGES_TO_BUILD" | xargs)
          
          BUILD_SUCCESS=true

          if [ -n "$PACKAGES_TO_BUILD" ]; then
            for PKG in $PACKAGES_TO_BUILD; do
              echo "::group::ğŸ“¦ Building Package: $PKG"
              make package/$PKG/compile $V_FLAG -j$(nproc) || {
                echo "âŒ Failed to build package: $PKG"
                BUILD_SUCCESS=false
              }
              echo "::endgroup::"
            done
          else
            echo "::group::ğŸ“¦ Building all custom packages"
            make package/compile $V_FLAG -j$(nproc) || BUILD_SUCCESS=false
            echo "::endgroup::"
          fi
          
          if [ "$BUILD_SUCCESS" = "true" ]; then
            echo "::group::âœ’ï¸ Creating package index"
            make package/index $V_FLAG || echo "âš ï¸ Failed to create package index."
            echo "::endgroup::"
          else
            echo "::error::One or more packages failed to build."
            exit 1
          fi

      - name: ğŸ—‚ï¸ Collect Artifacts
        if: always()
        run: |
          echo "::group::ğŸ—‚ï¸ Preparing Artifacts"
          mkdir -p $GITHUB_WORKSPACE/artifacts/bin/packages/${{ matrix.arch }}
          mkdir -p $GITHUB_WORKSPACE/artifacts/logs
          
          cd $SDK_PATH
          
          echo "Copying built packages..."
          if [ "${{ matrix.release }}" = "SNAPSHOT" ]; then
            find bin/packages/${{ matrix.arch }}/custom/ -type f -name "*.apk" -exec cp {} $GITHUB_WORKSPACE/artifacts/bin/packages/${{ matrix.arch }}/ \; 2>/dev/null || echo "No APK packages found to copy."
          else
            find bin/packages/custom/${{ matrix.arch }}/ -type f -name "*.ipk" -exec cp {} $GITHUB_WORKSPACE/artifacts/bin/packages/${{ matrix.arch }}/ \; 2>/dev/null || echo "No IPK packages found to copy."
          fi
          
          echo "Copying build logs..."
          find logs/ -type f -name "*.log" -exec cp {} $GITHUB_WORKSPACE/artifacts/logs/ \; 2>/dev/null || true
          
          echo "âœ¨ Artifacts structure:"
          ls -R $GITHUB_WORKSPACE/artifacts
          echo "::endgroup::"

      - name: ğŸ“¤ Upload Packages Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-packages-${{ matrix.release }}-${{ matrix.arch }}
          path: ${{ github.workspace }}/artifacts/bin/packages/${{ matrix.arch }}/*
          retention-days: 5

      - name: ğŸ“¤ Upload Build Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.release }}-${{ matrix.arch }}
          path: ${{ github.workspace }}/artifacts/logs/
          retention-days: 5

  push_packages:
    needs: build_ipk
    if: success() || failure()
    name: ğŸš€ Push Packages to gh-pages
    permissions:
      contents: write
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸš€ Checkout gh-pages Branch
        uses: actions/checkout@v4
        with:
          ref: 'gh-pages'

      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ğŸ“‚ Organize Packages
        run: |
          echo "::group::Sorting packages into release directories"
          for dir in ./artifacts/openwrt-packages-*; do
            if [ -d "$dir" ]; then
              # Format: openwrt-packages-RELEASE-ARCH
              RELEASE=$(echo "$dir" | cut -d'-' -f3)
              ARCH=$(echo "$dir" | cut -d'-' -f4)
              
              if [[ "$RELEASE" == "SNAPSHOT" ]]; then
                TARGET_DIR="releases/snapshot/packages/$ARCH"
              else
                VERSION_MAJOR=$(echo $RELEASE | cut -d'.' -f1-2)
                TARGET_DIR="releases/$VERSION_MAJOR/packages/$ARCH"
              fi
              
              echo "Moving packages from $dir to $TARGET_DIR"
              mkdir -p "$TARGET_DIR"
              mv $dir/* "$TARGET_DIR/"
            fi
          done
          echo "::endgroup::"
          
          echo "::group::Final repository structure"
          ls -R releases
          echo "::endgroup::"
          
          rm -rf ./artifacts

      - name: ğŸ’¾ Commit and Push Changes
        run: |
          git config --local user.name "GitHub Action"
          git config --local user.email "actions-user@users.noreply.github.com"
          git add releases
          if ! git diff --staged --quiet; then
            git commit -m "ğŸš€ Update Packages - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push
          else
            echo "âœ… No new packages to commit."
          fi

  build_and_deploy_pages:
    needs: push_packages
    if: inputs.without_pages == false && success() || failure()
    name: ğŸŒ Deploy to GitHub Pages
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸš€ Checkout gh-pages Branch
        uses: actions/checkout@v4
        with:
          ref: 'gh-pages'
          submodules: true

      - name: ğŸ’ Setup Ruby and Jekyll
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: ğŸ“œ Run Pre-build Script
        env:
          SERVER_HOME: releases
        run: |
          if [ -f "./prenodes.sh" ]; then
            echo "Running prenodes.sh..."
            chmod +x ./prenodes.sh
            ./prenodes.sh
          else
            echo "prenodes.sh not found, skipping."
          fi

      - name: ğŸ› ï¸ Configure GitHub Pages
        id: pages
        uses: actions/configure-pages@v5

      - name: ğŸ—ï¸ Build with Jekyll
        run: bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: production

      - name: ğŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4